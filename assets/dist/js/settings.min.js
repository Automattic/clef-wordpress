/*! Clef for WordPress - v2.0.0
 * http://getclef.com
 * Licensed GPLv2+ */
(function(e){var t;return t=Backbone.View.extend({el:"#invite-users-settings",events:{"click a[name='invite-users-button']":"inviteUsers"},messageTemplate:_.template("<div class='<%=type%> invite-users-message'><%=message%></div>"),showMessage:function(e,t){var i;return i=this.$el.find(".invite-users-message"),i.length&&i.remove(),this.$el.find(".button").first().before(this.messageTemplate({type:e,message:t}))},template:function(){return _.template(e("#invite-users-template").html())},initialize:function(e){return this.opts=e,this.opts.el?this.setElement(this.opts.el):void 0},inviteUsersAction:ajaxurl+"?action=clef_invite_users",inviteUsers:function(t){var i;return t.preventDefault(),i={_wp_nonce:this.opts.nonces.inviteUsers,roles:e("select[name='invite-users-role']").val()},e.post(this.inviteUsersAction,i,function(e){return function(t){var i,s;return i="",s="",t.error?(i="There was a problem sending invites: "+t.error+".",s="error"):t.success&&(e.trigger("invited"),i="Email invitations have been sent to your users.",s="updated"),e.showMessage(s,i)}}(this))},hideButton:function(){return this.$el.find(".button").hide()},render:function(){return this.$el.html(this.template)}}),this.InviteUsersView=t}).call(this,jQuery),function(){var e,t;return t=AjaxSettingsView.extend({el:"#multisite-settings",initialize:function(i){return this.modelClass=e,t.__super__.initialize.call(this,i)}}),e=AjaxSettingsModel.extend({parse:function(t,i){return i.url=ajaxurl+"?action=clef_multisite_options",e.__super__.parse.call(this,t,i)}}),this.MultisiteOptionsModel=e,this.MultisiteOptionsView=t}.call(this,jQuery),function(e,t){var i,s,n,r;return r=t.View.extend({el:e("#clef-tutorial"),messageTemplate:_.template("<div class='<%=type%> tutorial-message'><%=message%></div>"),events:{"click .next":"next","click .previous":"previous","click .done":"done"},slideClass:"sub",initialize:function(t){var i,s,r,o;for(this.opts=t,window.chrome&&this.$el.find(".waltz").addClass(this.slideClass),this.subs=[],i=this.$el.find("."+this.slideClass).filter(this.opts.slideFilterSelector),r=0,o=i.length;o>r;r++)s=i[r],this.subs.push(new n({el:s}));return this.currentSub=this.subs[0],e(window).on("message",this.handleMessages.bind(this))},hide:function(e){return this.$el.slideUp(e)},render:function(){return this.$el.is(":visible")?void 0:(this.currentSub.render(),this.$el.fadeIn())},done:function(){return this.trigger("done")},next:function(){var e;return e=this.subs[_.indexOf(this.subs,this.currentSub)+1],e?(e.isLogin()&&this.loggedIn&&(e=this.subs[_.indexOf(this.subs,this.newSub)+1]),this.currentSub.hide(),e.render(),this.currentSub=e,this.trigger("next")):this.done()},previous:function(){var e;return e=this.subs[_.indexOf(this.subs,this.currentSub)-1],e?(this.currentSub.hide(),e.render(),this.currentSub=e):void 0},handleMessages:function(e){return e.originalEvent.origin.indexOf(this.opts.clefBase>=0)?e.originalEvent.data:void 0},connectClefAccount:function(t,i){var s;return s={_wp_nonce:this.opts.nonces.connectClef,identifier:t.identifier},e.post(this.connectClefAccountAction,s,function(e){return function(t){var s;return t.error?(s="There was a problem automatically connecting your Clef account: "+t.error+". Please refresh and try again.",e.trigger("message",{message:s,type:"error"})):"function"==typeof i?i(t):void 0}}(this))},showMessage:function(t){return this.$currentMessage&&this.$currentMessage.remove(),this.$currentMessage=e(this.messageTemplate(t)).hide().prependTo(this.$el).slideDown(),t.removeNext?this.listenToOnce(this,"next",function(){return this.$currentMessage.slideUp()}):void 0}},{extend:t.View.extend}),n=t.View.extend({initialize:function(t){return this.opts=t,this.setElement(e(this.opts.el))},render:function(){return this.$el.show()},hide:function(){return this.$el.hide()},remove:function(){return this.$el.remove()},isLogin:function(){return this.$el.find("iframe.setup").length}}),s=r.extend({connectClefAccountAction:ajaxurl+"?action=connect_clef_account_clef_id",iframePath:"/iframes/application/create/v1",initialize:function(e){return e.slideFilterSelector=".setup",this.constructor.__super__.initialize.call(this,e),this.inviter=new InviteUsersView(_.extend({el:this.$el.find(".invite-users-container")},this.opts)),this.listenTo(this.inviter,"invited",this.usersInvited)},render:function(){return this.userIsLoggedIn&&this.$el.addClass(this.currentSub.$el.hasClass("sync")?"user":"no-sync"),this.$el.is(":visible")||(this.loadIFrame(),this.inviter.render()),this.constructor.__super__.render.call(this)},loadIFrame:function(){var e,t;return e=this.$el.find("iframe.setup"),t=""+this.opts.clefBase+this.iframePath+"?source="+encodeURIComponent(this.opts.setup.source)+"&domain="+encodeURIComponent(this.opts.setup.siteDomain)+"&name="+encodeURIComponent(this.opts.setup.siteName),e.attr("src",t)},handleMessages:function(e){var t;return(e=this.constructor.__super__.handleMessages.call(this,e))?"keys"===e.type?this.connectClefAccount({identifier:e.clefID},function(t){return function(){return t.trigger("applicationCreated",e),t.next()}}(this)):"user"===e.type?(this.userIsLoggedIn=!0,this.render()):"error"===e.type?(t="There was a problem creating a new Clef application for your WordPress site: "+e.message+". Please refresh and try again. If the issue, persists, email support@getclef.com.",this.showMessage({message:t,type:"error"})):void 0:void 0},onConfigured:function(){return setTimeout(function(){return e(".logout-hook-error").slideDown()},2e4)},usersInvited:function(){return this.inviter.hideButton(),setTimeout(function(e){return function(){return e.currentSub.$el.hasClass("invite")?e.currentSub.$el.find(".button").addClass("button-primary"):void 0}}(this),1e3)}}),i=r.extend({connectClefAccountAction:ajaxurl+"?action=connect_clef_account_oauth_code",render:function(){return this.$el.is(":visible")||this.addButton(),this.constructor.__super__.render.call(this)},addButton:function(){var t;return t=e("#clef-button-target").attr("data-app-id",this.opts.appID).attr("data-redirect-url",this.opts.redirectURL),this.button=new ClefButton({el:e("#clef-button-target")[0]}),this.button.render(),this.button.login=function(e){return function(t){return e.button.overlayClose(),void e.connectClefAccount({identifier:t.code},function(){var t;return t="You've successfully connected your account with Clef!",e.next(),e.showMessage({message:t,type:"updated",removeNext:!0})})}}(this)},message:function(){}}),this.TutorialView=r,this.SetupTutorialView=s,this.ConnectTutorialView=i}.call(this,jQuery,Backbone),function(e){var t,i,s,n;return Backbone.emulateHTTP=!0,t=Backbone.View.extend({el:e("#clef-settings-container"),initialize:function(e){return this.opts=e,this.$msgContainer=this.$el.find(".message"),this.settings=new n(_.extend({options_name:"wpclef"},this.opts)),this.tutorial=new SetupTutorialView(_.extend({},this.opts)),this.opts.isNetworkSettings&&(delete this.opts.formSelector,this.multisiteOptionsView=new MultisiteOptionsView(this.opts)),this.listenTo(this.settings,"message",this.displayMessage),this.listenTo(this.tutorial,"message",this.displayMessage),this.render()},render:function(){return this.opts.isUsingIndividualSettings||this.opts.isNetworkSettings&&this.opts.isNetworkSettingsEnabled?(this.multisiteOptionsView&&this.multisiteOptionsView.show(),this.settings.isConfigured()?this.settings.show():(this.tutorial.render(),this.listenToOnce(this.tutorial,"applicationCreated",this.configure),this.listenToOnce(this.tutorial,"done",this.hideTutorial))):void 0},configure:function(e){return this.settings.model.configure(e)},displayMessage:function(e){return this.$msgContainer.find("p").text(e.message),this.$msgContainer.addClass(e.type).slideDown(),e.fade?setTimeout(function(){return this.$msgContainer.slideUp()},3e3):void 0},hideTutorial:function(){return this.settings.isConfigured()&&this.displayMessage("You're all set up!",{type:"updated"}),this.tutorial.hide(),this.settings.show()}}),n=AjaxSettingsView.extend({errorTemplate:_.template("<div class='error form-error'><%=message%></div>"),genericErrorMessage:"Something went wrong, please refresh and try again.",addEvents:{"click .generate-override":"generateOverride","click input[type='submit']:not(.ajax-ignore)":"saveForm"},constructor:function(e){return this.events=_.extend(this.events,this.addEvents),n.__super__.constructor.call(this,e)},initialize:function(e){return this.opts=e,this.modelClass=s,n.__super__.initialize.call(this,e),this.inviteUsersView=new InviteUsersView(e),this.formView=new i({model:this.model}),this.xmlEl=this.model.cFindInput("clef_password_settings_xml_allowed").parents(".input-container"),this.overrideContainer=this.$el.find(".override-settings"),this.overrideButtonContainer=this.$el.find(".override-buttons"),this.setOverrideLink(),this.badgePreviewContainer=this.$el.find(".support-settings .ftr-preview"),this.listenTo(this.model,"change",this.clearErrors),this.listenTo(this.model,"error",this.error),window.onbeforeunload=function(e){return function(){return e.isSaving()?"Settings are being saved. Still want to navigate away?":void 0}}(this),this.render()},updated:function(e,t){return n.__super__.updated.call(this,e,t),this.setOverrideLink()},render:function(){var t;return n.__super__.render.call(this),t=this.model.passwordsDisabled(),e("#clef-settings-header").show(),this.xmlEl.toggle(t),this.toggleOverrideContainer(t),this.overrideButtonContainer.toggle(this.model.overrideIsSet()),this.inviteUsersView.render(),this.renderSupportBadge()},toggleInputs:function(e){return this.formView.toggleForm(!!parseInt(e.currentTarget.value))},toggleOverrideContainer:function(e){return this.overrideContainer.toggle(e)},generateOverride:function(){var e;return e=Math.random().toString(36).slice(2),this.model.save({"wpclef[clef_override_settings_key]":e})},setOverrideLink:function(){var e,t;return(t=this.model.overrideKey())?(this.overrideBase||(this.overrideBase=this.overrideContainer.find("label").text()),e=this.overrideButtonContainer.find("a"),e.on("click",function(e){return e.preventDefault()}),e.attr("href",this.overrideBase+t)):void 0},isSaving:function(){return this.model.saving},renderSupportBadge:function(){var e;return e=this.model.badgeSetting(),this.badgePreviewContainer.toggle("disabled"!==e),this.badgePreviewContainer.find("a").toggleClass("pretty","badge"===e)},isConfigured:function(){return this.model.isConfigured()},clearErrors:function(e){var t,i,s,n,r;n=e.changed,r=[];for(i in n)s=n[i],t=this.model.findInput(i).parents(".input-container"),r.push(t.hasClass("error")?t.removeClass("error").next(".error.form-error").remove():void 0);return r},error:function(e,t){var i,s,n,r,o;if(!t.responseJSON.errors)return this.trigger("message",{message:this.genericErrorMessage,type:"error"}),void window.scrollTo(0,0);r=t.responseJSON.errors,o=[];for(s in r)n=r[s],i=this.model.cFindInput(s).parents(".input-container"),o.push(i.hasClass("error")?i.next(".error.form-error").html(n):i.addClass("error").after(this.errorTemplate({message:n})));return o},saveForm:function(e){return e.preventDefault(),this.model.save({},{success:function(e){return function(){return e.trigger("message",{message:"Settings saved.",type:"updated"}),window.scrollTo(0,0)}}(this),error:this.model.saveError.bind(this.model)})}}),s=AjaxSettingsModel.extend({cFindInput:function(e){return this.findInput("wpclef["+e+"]")},cget:function(e){return this.get("wpclef["+e+"]")},passwordsDisabled:function(){return!!parseInt(this.cget("clef_password_settings_disable_passwords"))||""!==this.cget("clef_password_settings_disable_certain_passwords")||this.passwordsFullyDisabled()},passwordsFullyDisabled:function(){return!!parseInt(this.cget("clef_password_settings_force"))},overrideIsSet:function(){return!!this.overrideKey()},overrideKey:function(){return this.cget("clef_override_settings_key")},badgeSetting:function(){return this.cget("support_clef_badge").toLowerCase()},isConfigured:function(){return!(!this.cget("clef_settings_app_id")||!this.cget("clef_settings_app_secret"))},configure:function(e){return this.save({"wpclef[clef_settings_app_id]":e.appID,"wpclef[clef_settings_app_secret]":e.appSecret})}}),i=Backbone.View.extend({el:e("#login-form-view"),template:function(){return _.template(e("#form-template").html())},initialize:function(e){return this.opts=e,this.model=this.opts.model,this.listenTo(this.model,"change",this.toggleForm),this.render()},render:function(){return this.$el.html(this.template),this.$el.find('input[type="submit"]').on("click",function(e){return e.preventDefault()}),this.toggleForm()},toggleForm:function(){return this.$el.toggleClass("only-clef",this.model.passwordsFullyDisabled())}}),this.AppView=t,e.fn.serializeObject=function(){var t,i,s,n,r;for(i={},r=e(this).serializeArray(),s=0,n=r.length;n>s;s++)t=r[s],i[t.name]=t.value;return i}}.call(this,jQuery);